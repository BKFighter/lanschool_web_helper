var g_canvas=null;var g_context=null;var g_width=0;var g_height=0;function calculateScale(f,l,i,b){var a=null;var g=1;var j=0;var d=0;var e=0;var k=0;var c=i/f;var h=b/l;if(c<h){g=c}else{g=h}return g}function requestTabThumbnail(e,c,i,h){var d=0;var g=0;var f=0;var a=0;var b=null;if(!g_canvas){g_canvas=document.createElement("canvas")}chrome.tabs.captureVisibleTab({format:"jpeg",quality:100},function(k){if(chrome.runtime.lastError||(typeof k==="undefined")){chrome.runtime.sendMessage(e,{message:"thumbnail_response",width:0,height:0,base64:""});return}var j=new Image;j.src=k;g_canvas.width=c;g_canvas.height=i;j.onload=function(){b=g_canvas.getContext("2d");scale=calculateScale(j.width,j.height,c,i);var m=Math.round(j.width*scale);var n=Math.round(j.height*scale);b.fillStyle="#000000";b.fillRect(0,0,c,i);if(c>m){f=Math.round((c-m)/2)}if(i>n){a=Math.round((i-n)/2)}b.drawImage(j,f,a,m,n);var o=g_canvas.toDataURL("image/jpeg");var p=b.getImageData(0,0,c,i);var l=ArrayBufferToBase64(p.data);chrome.runtime.sendMessage(e,{message:"thumbnail_response",width:p.width,height:p.height,base64:(h==="jpeg")?o:l,format:h})}})};