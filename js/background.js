"use strict";var lastUrl="";var lastTitle="";var lastBlockedUrl="";var useXMLHttp=true;var limitingFlags=0;var limitingState=0;var urlList=[];var rawUrlList=[];var urlListType=0;var receivedHeartBeat=false;var blockIPAddresses=false;var blockIncognito=false;var tabWindowId=0;var studentConfigReceived=false;var lastLimitFlags=0;var limitTimeout=30;var ALLOW_ALL="0";var BLOCK_ALL="1";var ALLOW_SPECIFIC="2";var BLOCK_SPECIFIC="3";var DISABLE_WEB_PORT80=2147483872;var ALLOW_SPECIFIC_APPS=524512;var DISABLE_SPECIFIC_APPS=1048800;var DISABLE_DOTTEDCECIMALS=4194304;var DISABLE_WEB_CHROME=480;var ENABLE_TASKMANAGER=736;var DISABLE_PRIVATE_BROWSE=1248;var DISABLE_TASKMANAGER=4320;var ChromeAppsWhitelist=["cclepbmimdmoahcbccbpbnpfnaakheja","ifeifkfohlobcbhmlfkenopaimbmnahb","hgdgmhjbhldlejgpjbphhoegapekcbcc","glifclcedbcpeplpmnplaekopdgjggcd","jhiggjblhjhknbhjffjpfoanbghcfmga","cdjokdjlmmgodojedmlfppkfnnjnfigf","kmklemnfjbnkliegakkhbbljlmhohcjf"];var currentStudent="";var myPort=56797;var portDead=false;var portDeadCnt=0;var studentConfigData=null;var last_blockedUrl="";var neverBlock=["chrome-extension://","chrome://","chrome-devtools://","file://"];var blockEventsList=[];function PostHistory(c,g){if(useXMLHttp==false){return}if(portDead){portDeadCnt++;return}try{if(!c.active){return}if(c.url.valueOf()==lastBlockedUrl.valueOf()){return}var d=JSON.stringify(c.title);d=d.trim();if(c.url.valueOf()!=lastUrl.valueOf()&&lastTitle.valueOf()!=d.valueOf()){if(useXMLHttp==false){return}var b=new XMLHttpRequest();if(!g){g="en"}b.open("POST","http://localhost:"+myPort+"/History",true);var a=JSON.stringify({url:c.url,title:d,lang:g,windowId:c.windowId});b.setRequestHeader("Content-Type","application/json");b.send(a);lastUrl=c.url;lastTitle=d}else{}}catch(f){console.log("exception in PostHistory: "+f.message+" code "+f.code);if(f.code==19){console.log("network error!");portDead=true}}}function PostNewUrl(c){if(useXMLHttp==false){return}if(portDead){portDeadCnt++;if(portDeadCnt>10){portDeadCnt=0;portDead=false;console.log("Reset portDead")}return}if(c&&c.url&&c.url.substring(0,9)=="chrome://"){return}try{var b=new XMLHttpRequest();b.open("POST","http://localhost:"+myPort+"/WebLimit",true);var a=JSON.stringify({url:c.url});b.setRequestHeader("Content-Type","application/json");b.onerror=function(f){console.log("Caught request error: "+f.currentTarget.readyState);portDead=true};b.onload=function(l){var h=b.responseText;h=h.trim();if(b.status==200){var g=JSON.parse(h);if(g.block!=null){if(g.block=="true"){lastBlockedUrl=c.url;if(c.url.substring(0,12)=="view-source:"){chrome.tabs.remove(c.id,null);console.log("tried to remove the view-source tab!")}else{var j=function(){var p=document.getElementsByTagName("video");var e;for(e=0;e<p.length;e++){p[e].pause()}p=document.getElementsByTagName("audio");for(e=0;e<p.length;e++){p[e].pause()}};j();var k=JSON.stringify(g.redirect);var m="&quot;";var o=new RegExp(m,"g");k=k.replace(o,'\\"');var n='document.head.innerHTML = ""; document.body.innerHTML = '+k+";";console.log("PostNewUrl: site is blocked: "+c.url);chrome.tabs.insertCSS(c.tabId,{file:"style.css",runAt:"document_end"},function f(){if(chrome.runtime.lastError){}});chrome.tabs.executeScript(c.tabId,{code:n},function i(e){if(chrome.runtime.lastError){}})}}else{console.log("PostNewUrl: site is allowed: "+c.url);if(c.url==lastBlockedUrl){lastBlockedUrl=""}}}else{console.log("PostNewUrl failed to get response from sserver")}}else{console.log("PostNewUrl bad response from sserver: "+b.status)}};b.send(a)}catch(d){console.log("exception in PostNewUrl: "+d.message+" code "+d.code);if(d.code==19){console.log("network error!");portDead=true}}}function postURL_onLoad(a){}function discoverPort(){chrome.runtime.getPlatformInfo(function(b){console.log("operating system: "+b.os);if(b.os=="win"){console.log("trying to load file");try{var d=chrome.extension.getURL("svrproc42");console.log(d);var c=new XMLHttpRequest();c.open("GET",d,true);c.onreadystatechange=function(){if(c.readyState==XMLHttpRequest.DONE&&c.status==200){console.log(c.responseText);myPort=c.responseText.toString().trim();console.log("myPort = "+myPort.toString())}};c.send(null)}catch(a){console.log("discoverPort exception: "+a.message)}}else{if(b.os==="cros"){console.log("Chromebook, disabling XMLHttp!");useXMLHttp=false;enableChromeStudentListeners();reEnableBrowsing()}else{console.log("not windows")}}})}function connectListeners(){enableIcon(false);discoverPort();chrome.tabs.onActivated.addListener(ontabactivated);chrome.webNavigation.onCompleted.addListener(navigationOnCompleted);chrome.tabs.onUpdated.addListener(tabOnUpdated);chrome.runtime.onMessageExternal.addListener(function(d,c,a){if(!isAppInWhitelist(c.id)){console.log("Rejecting message from "+c.id+". (not in whitelist)");return}var e=false;switch(d.message){case"DisableXMLHttp":disableXMLHttp();if(studentConfigData){a({message:"StudentConfigData",data:studentConfigData})}break;case"WebLimitFlags":var b=d.value.split("::");console.log("WebLimiting flags: "+d.value.toString(16));limitingFlags=parseInt(b[0]);limitingState=parseInt(b[1]);lastLimitFlags=Math.round(new Date().getTime()/1000);if((limitingFlags&DISABLE_DOTTEDCECIMALS)==DISABLE_DOTTEDCECIMALS){blockIPAddresses=true;console.log("IP Browsing disabled")}else{blockIPAddresses=false}if((limitingFlags&DISABLE_PRIVATE_BROWSE)==DISABLE_PRIVATE_BROWSE){blockIncognito=true;console.log("Incognito Browsing disabled")}else{blockIncognito=false}disableXMLHttp();break;case"WebLimitURLList":disableXMLHttp();handleURLList(d.value);break;case"RunURL":console.log("RunURL: "+d.value.url);handleRunURL(d.value,a);break;case"HeartBeat":currentStudent=c.id;receivedHeartBeat=true;disableXMLHttp();if(studentConfigData){a({message:"StudentConfigData",data:studentConfigData})}break;case"get_screenshot":if(a){a({message:"ACK",width:0,height:0,data:"pending"});requestTabThumbnail(c.id,d.width,d.height,d.format)}break;default:}});chrome.runtime.onMessage.addListener(function(d,c,b){if(d.message==="student_config"){console.log("CONFIG: "+d.data);if(studentConfigReceived===false){studentConfigData=d.data;studentConfigReceived=true;console.log("currentStudent = '"+currentStudent+"'");if(currentStudent!=""){chrome.runtime.sendMessage(currentStudent,{message:"StudentConfigData",data:d.data},function(f){})}}}else{if(d.message==="limiting_list"){console.log("Got limiting_info message. Looking for event index "+d.index);var e={};for(var a=0;a<blockEventsList.length;a++){if(blockEventsList[a].id===d.index){e=blockEventsList[a]}}b({limitingState:limitingState,UrlList:rawUrlList,urlListType:parseInt(urlListType),blockedUrl:e.url})}}});chrome.tabs.onUpdated.addListener(function(a){chrome.browserAction.disable(a.id)})}function enableChromeStudentListeners(){console.log("Enabling Chrome student listener");chrome.webRequest.onBeforeRequest.addListener(function(a){if(!receivedHeartBeat){return}if(isNeverBlocked(a.url)){return}var d=false;switch(a.type){case"sub_frame":case"main_frame":var i=chrome.extension.getURL("blocked.html");if(a.url.indexOf(i)>-1){break}lastUrl=a.url;if(a.type=="main_frame"&&currentStudent!==""){chrome.runtime.sendMessage(currentStudent,{message:"WebURLChanged",url:a.url,title:"",lang:"",windowId:a.tabId},function(k){})}if(urlListType!=0){var g=escape(a.url);var e="";var b="blocked";var j=parseURLex(a.url);var c="";last_blockedUrl=a.url;if(blockIPAddresses&&j.isIP){d=true;b="noip"}else{switch(urlListType){case BLOCK_ALL:d=true;c="Web disabled";break;case ALLOW_SPECIFIC:d=!isURLInBlockedList(a.url);b="allowed";if(d){for(var h=0;h<urlList.length;h++){if(h>0){e+=","}e+=rawUrlList[h]}lastBlockedUrl=a.url;c="Page not in allowed list"}break;case BLOCK_SPECIFIC:d=isURLInBlockedList(a.url);if(d){lastBlockedUrl=a.url;c="Page in blocked list"}break}}if(d){console.log("Blocking page: ["+a.url+"] ("+c+")");var f=timeStamp();blockEventsList[blockEventsList.length]={id:f,url:a.url};return{redirectUrl:chrome.extension.getURL("blocked.html?index="+f)}}}break;case"stylesheet":case"script":case"image":case"object":case"xmlhttprequest":case"other":break}},{urls:["<all_urls>"]},["blocking"]);window.setInterval(checkLimitingTimeout,20000)}function checkLimitingTimeout(){if(lastLimitFlags===0||(urlListType===0)){return}var a=Math.round(new Date().getTime()/1000);var b=lastLimitFlags+limitTimeout;if(a>(lastLimitFlags+limitTimeout)){console.log("It's been a while since we've recived a status from the teacher.  Disabling web limiting.");reEnableBrowsing()}}function disableXMLHttp(){if(useXMLHttp==true){console.log("Disabling XMLHttp methods and listeners");useXMLHttp=false;chrome.tabs.onActivated.removeListener(ontabactivated);chrome.tabs.onUpdated.removeListener(tabOnUpdated);reEnableBrowsing();enableChromeStudentListeners()}}function ontabactivated(a){if(a&&a.tabId&&a.tabId>0){chrome.tabs.get(a.tabId,function(b){if(chrome.runtime.lastError||!b){return}if(b.url){PostNewUrl(b)}})}}function navigationOnCompleted(a){if(a&&a.tabId&&a.url&&a.tabId>0){chrome.tabs.get(a.tabId,function(b){if(chrome.runtime.lastError){console.log("chrome.tabs.get() error: "+chrome.runtime.lastError.message);return}if(b&&b.url){chrome.tabs.detectLanguage(b.tabId,function(c){PostHistory(b,c)})}})}}function tabOnUpdated(b,a,c){if(b&&b>0){chrome.tabs.get(b,function(d){if(d&&d.url){PostNewUrl(d)}})}}function detectStudentConfig(){console.log("Detecting Student configuration data")}function reEnableBrowsing(){urlListType=0;blockIPAddresses=false;blockIncognito=false;updateWebLimitingIcon(false)}function handleURLList(d){var e=JSON.parse(d);urlList.length=0;rawUrlList.length=0;urlListType=e.listType;if(urlListType==0){reEnableBrowsing()}else{updateWebLimitingIcon(true)}if(e.entries&&e.entries.length>0){for(var a=0;a<e.entries.length;a++){var c=0;rawUrlList[a]=e.entries[a];var b=e.entries[a];b=b.replace(/[.]/g,"[.]");b=b.replace(/\*/g,".*");b=b.replace(/\?/g,".");b=b.replace(/\//g,"[/]");c=b.search(/\.\*/);if(c===0){urlList[a]=new RegExp(b,"i")}else{urlList[a]=new RegExp(".*[.]{0,1}"+b,"i")}}}validateCurrentTabs()}function updateWebLimitingIcon(a){if(useXMLHttp==false){if(a){chrome.browserAction.setIcon({path:"./disableweb.png"});chrome.browserAction.setTitle({title:chrome.i18n.getMessage("web_limited")})}else{chrome.browserAction.setIcon({path:"./icon16.png"});chrome.browserAction.setPopup({popup:""});chrome.browserAction.setTitle({title:""})}}}function validateCurrentTabs(){var c=new Array();var b=false;var a="";chrome.tabs.query({},function(g){for(var f=0;f<g.length;f++){a="";if(isNeverBlocked(g[f].url)){continue}var e=parseURLex(g[f].url);var d=escape(g[f].url);var h=timeStamp();blockEventsList[blockEventsList.length]={id:h,url:g[f].url};if(blockIPAddresses&&e.isIP){chrome.tabs.update(g[f].id,{url:chrome.extension.getURL("blocked.html?index="+h)});continue}if(g[f].incognito&&blockIncognito){chrome.tabs.remove(g[f].id);continue}switch(urlListType){case BLOCK_ALL:b=true;chrome.tabs.update(g[f].id,{url:chrome.extension.getURL("blocked.html?index="+h)});break;case ALLOW_SPECIFIC:b=!isURLInBlockedList(g[f].url);if(b){chrome.tabs.update(g[f].id,{url:chrome.extension.getURL("blocked.html?index="+h)})}break;case BLOCK_SPECIFIC:b=isURLInBlockedList(g[f].url);if(b){lastBlockedUrl=g[f].url;chrome.tabs.update(g[f].id,{url:chrome.extension.getURL("blocked.html?index="+h)})}break}}})}function enableIcon(a){console.log("Setting icon to: "+a);chrome.tabs.query({},function(c){for(var b=0;b<c.length;b++){chrome.browserAction.disable(c[b].id)}})}function timeStamp(){return new Date().getTime()}function isAppInWhitelist(c){var b=ChromeAppsWhitelist.length;for(var a=0;a<b;a++){if(ChromeAppsWhitelist[a]===c){return true}}return false}function handleRunURL(d,a){var c=d.url;var e=d.teacher;var b=d.flags;console.log("Received RunURL from teacher: "+e+" URL: ["+c+"]");if(typeof chrome.tabs!="undefined"){chrome.tabs.query({},function(g){for(var f=0;f<g.length;f++){if(g[f].selected){chrome.tabs.update(g[f].id,{url:c});a({message:"OK",data:""});return true}}if(window.open(c)!=null){a({message:"OK",data:""})}else{a({message:"no_tab",data:"unable to open tab"})}})}else{console.log("no tabs open, creating a new window");window.open(c)}return false}function isURLInBlockedList(b){var d=false;var c=urlList.length;for(var a=0;a<c;a++){if(b.match(urlList[a])){d=true}}return d}function isNeverBlocked(b){var c=neverBlock.length;for(var a=0;a<c;a++){if(b.match(neverBlock[a])){return true}}return false}function checkCurrentTabsForConfig(){chrome.tabs.query({},function(b){for(var a=0;a<b.length;a++){if((b[a].url.indexOf("chrome-devtools://")==-1)&&(b[a].url.indexOf("chrome://")==-1)){chrome.tabs.executeScript(b[a].id,{file:"js/configstudent.js"},function(c){if(chrome.runtime.lastError){console.log("Script not executed: "+chrome.runtime.lastError.message)}})}}})}connectListeners();checkCurrentTabsForConfig();